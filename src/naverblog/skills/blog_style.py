"""블로그 스타일 분석 스킬 - byhur99 보보쌤 블로그 기반.

스타일 데이터는 DB에 저장되며, 웹 UI에서 편집 가능.
DB에 없으면 아래 기본값(DEFAULT_*)을 사용하고 자동으로 DB에 시드합니다.
"""

from __future__ import annotations

from naverblog.skills.base import SkillBase, SkillContext, SkillResult

# ──────────────────────────────────────────────
# 기본값 (DB에 값이 없을 때 사용, 최초 시드용)
# ──────────────────────────────────────────────
DEFAULT_COMMON_STYLE = """\
## 보보쌤 블로그 공통 스타일 가이드

### 블로그 정체성
- 블로그명: 의대 간 보보쌤의 공부 & 입시 연구소
- 필자: 보보쌤 (서울대 졸, 수시 6관왕, 퇴사 후 77일만에 의대/한의대 합격, 전 대치동 입시 컨설턴트)
- 타겟: 고등학생, 수험생, 학부모, 직장인 수험생

### 문체 규칙
- 기본 어미: ~합니다/~해요 혼용 (친근하면서도 신뢰감)
- 감정 표현: ㅠㅠ, ㅎㅎ, !! 등 자연스럽게 사용
- 괄호 부연: (사실 가고싶기는 했는데 너무 비쌌어요 ㅠㅠ) 식의 솔직한 부연
- 존칭: 독자를 "학생", "수험생", "학부모님" 등으로 호칭
- 강조: 핵심 키워드는 **굵게** 처리, 때로 가!장! 같은 감탄 표현

### 글 구조 (반드시 따라야 함)
1. **인사**: "안녕하세요 보보쌤입니다." 또는 "안녕하세요 [주제]로 돌아온 보보쌤입니다."
2. **보보쌤 소개 링크**: 소개글 참조 문구 (생략 가능)
3. **공감/질문 도입**: 독자의 고민이나 궁금증으로 시작
4. **개요**: "오늘의 개요는 다음과 같습니다." + 번호 리스트
5. **본문**: 번호로 구분된 섹션, 각 섹션에 소제목
6. **마무리**: 다음 글 예고 + "이웃추가, 새 글 알림 켜고 기다려주세요!"

### 특징적 표현
- "오늘의 개요는 다음과 같습니다."
- "제가 실제로 ~했던 경험을 기반으로"
- "어디에서도 안 알려주는 꿀팁"
- "이웃추가 부탁드려요"
- "컨설팅 문의는 댓글이나 카카오 채널로"
- "~하시는 분들은 아래 글 참고해주세요!"
- "찬찬히 잘 읽어주세요!"

### 콘텐츠 전략
- 개인 경험담을 근거로 제시
- 구체적 수치/데이터 포함 (등급, 비용, 기간 등)
- "좋은 예 vs 나쁜 예" 비교 자주 사용
- 체크리스트 형식 활용
- 관련 글 상호 링크 (시리즈 구성)"""

DEFAULT_CATEGORY_STYLES: dict[str, str] = {
    "과목별 공부 로직": """\
### 카테고리: 과목별 공부 로직
- **톤**: 교육적이고 체계적, 선생님이 알려주는 느낌
- **구조**: 과목 목차/흐름 설명 → 단원별 핵심 → 공부법 → 교재 추천
- **핵심 메시지**: "흐름을 알면 반은 간다", "기출이 가장 중요하다"
- **특징적 패턴**:
  - 교과서 목차 기반 흐름 설명
  - "이 질문에 답변할 수 있다면 어느 정도 준비된 학생"
  - N회독 공부법, 구체적 교재명 언급
  - 등급별 맞춤 공부법 제시
- **예시 도입부**: "오늘은 [과목] 공부법에 대해 알아보려고 합니다. 혹시 [과목]을 감으로 풀고 계신 건 아니죠?\"""",
    "입시 파이널 : 면접": """\
### 카테고리: 입시 파이널 : 면접
- **톤**: 코칭/멘토링, 실전 경험 기반 조언
- **구조**: 질문 제시 → 나쁜 예 → 좋은 예 → 답변 만드는 공식 → 꿀팁
- **핵심 메시지**: "준비한 것에서 다 나왔다", "답변을 만드는 법이 있다"
- **특징적 패턴**:
  - 실제 면접 질문 리스트 제공
  - Before/After 답변 예시
  - "1분 자기소개 해보세요" 같은 직접적 질문으로 시작
  - 복장, 긴장 관리 등 실전 팁 포함
- **예시 도입부**: "1분 자기소개 해보세요. 글의 시작부터 당황한 학생들이 많을 것이라고 생각합니다.\"""",
    "입시 파이널 : 자기소개서": """\
### 카테고리: 입시 파이널 : 자기소개서
- **톤**: 전문적이면서 친근한 컨설턴트
- **구조**: 모집요강 분석 → 항목별 작성법 → 예시 → 주의사항
- **핵심 메시지**: "처음부터 제대로 쓰려고 하면 안 된다", "6개의 소재를 먼저 선정하라"
- **특징적 패턴**:
  - 대학별 자소서 항목 구체적 분석
  - 작성 단계를 step by step으로 제시
  - "어떤 스토리를 짜야 하는지" 전략적 접근
  - 시리즈로 1탄, 2탄 연재
- **예시 도입부**: "안녕하세요. [대학] 자소서 쓰는 법으로 돌아온 보보쌤입니다. 제대로 쓰고 계신가요?\"""",
    "생기부 : 수시의 모든 것": """\
### 카테고리: 생기부 : 수시의 모든 것
- **톤**: 현실적 조언, 선배의 경험 공유
- **구조**: 과목 소개 → 좋은 예시 vs 나쁜 예시 → 퀄리티 높이는 법 → 주제 찾는 법
- **핵심 메시지**: "미리미리 탐구 주제를 설정해야 한다"
- **특징적 패턴**:
  - 실제 합격생의 세특 예시 공개
  - 좋은 예/나쁜 예 직접 비교
  - "왜 한정된 컨텐츠만 사용하려고 하는 걸까요?" 같은 인사이트
  - 첨삭 제안, 풀버전 공유 이벤트
- **예시 도입부**: "오늘은 [과목] 세특 예시를 보며 어떤 식으로 작성해야 하는지 알아보겠습니다.\"""",
    "77일만에 의대 가기": """\
### 카테고리: 77일만에 의대 가기
- **톤**: 개인 스토리텔링, 솔직하고 진정성 있는
- **구조**: 개인 경험 → 구체적 데이터/비용 → 팁 정리 → 감성적 마무리
- **핵심 메시지**: "비싼 학원비가 아니라 집요함이 결과를 만든다"
- **특징적 패턴**:
  - 본인의 실제 비용, 일정 공개
  - 카테고리별 상세 비용 breakdown
  - BEST/WORST 소비 비교
  - "저도 ~할 때 불안함에 떨며 계산기를 두드리던 때가 있었습니다" 같은 공감
- **예시 도입부**: "안녕하세요. 오늘은 정말 많은 분들이 궁금해하시는 [주제]로 돌아온 보보쌤입니다.\"""",
    "[전략] 입시 설계의 정석": """\
### 카테고리: [전략] 입시 설계의 정석
- **톤**: 분석적, 전략적, 데이터 기반
- **구조**: 문제 제기 → 데이터 분석 → 전략 제시 → 실행 방법
- **핵심 메시지**: "나에게 가장 유리한 방향을 먼저 파악하라"
- **특징적 패턴**:
  - 등급컷, 경쟁률 등 입시 데이터 인용
  - 대학별 전형 비교 분석
  - "내가 어떤 전형으로 지원해야 가장 유리할지 알고 있나요?" 같은 질문
  - 내신 계산 방법, 반영 비율 설명
- **예시 도입부**: "안녕하세요. [주제]를 분석해보려고 합니다. 혹시 내 성적으로 어디에 지원 가능한지 알고 계시나요?\"""",
    "시기별 로드맵": """\
### 카테고리: 시기별 로드맵
- **톤**: 가이드/로드맵, 계획 수립 도우미
- **구조**: 현 시기 분석 → 해야 할 것 리스트 → 과목별 전략 → 다음 단계 예고
- **핵심 메시지**: "무엇을 어떻게 해야 할지 막막한 분들을 위해"
- **특징적 패턴**:
  - 시기별(겨울방학, 3월 등) 맞춤 전략
  - 체크리스트 형식
  - "처음이라 뭘 해야 할지 모르겠다"는 공감에서 시작""",
    "학원 / 과외의 모든 것": """\
### 카테고리: 학원 / 과외의 모든 것
- **톤**: 솔직한 후기, 내돈내산 리뷰
- **구조**: 경험 소개 → 장단점 → 비용 공개 → 선택 체크리스트
- **핵심 메시지**: "잘 활용한다면 최고의 가성비"
- **특징적 패턴**:
  - 100% 내돈내산 강조
  - 시간표, 실제 가격 공개
  - 좋은 선생님/학원 고르는 체크리스트
  - "재종 갈지 독재 갈지 고민하는 분들" 타겟팅""",
    "블로그 활용법 (후기 zip)": """\
### 카테고리: 블로그 활용법 (후기 zip)
- **톤**: 감사/공유, 성과 보고
- **구조**: 소개 → 후기 모음 → 서비스 안내
- **핵심 메시지**: "순수하게 도움을 드리고자"
- **특징적 패턴**:
  - 합격 사례 모음
  - 무료 상담소 운영 안내
  - 컨설팅 후기 공유""",
    "입시 정보 모음": """\
### 카테고리: 입시 정보 모음
- **톤**: 정보 정리, 리서치 결과 공유
- **구조**: 정보 필요성 → 데이터 정리 → 전략적 활용법
- **핵심 메시지**: "제가 직접 입학처를 샅샅이 뒤지며 정리했습니다"
- **특징적 패턴**:
  - 대학별 지원 자격, 최저 등급 등 세부 데이터
  - 표/리스트 형태 정리
  - 매년 변경사항 업데이트""",
}


def seed_default_styles(db) -> None:
    """DB에 기본 스타일이 없으면 시드합니다."""
    if db.get_blog_style("common") is None:
        db.save_blog_style("common", DEFAULT_COMMON_STYLE)
    for cat_name, cat_style in DEFAULT_CATEGORY_STYLES.items():
        if db.get_blog_style(cat_name) is None:
            db.save_blog_style(cat_name, cat_style)


def get_available_categories(db) -> list[str]:
    """DB에 저장된 카테고리 이름 목록 (common 제외)."""
    styles = db.list_blog_styles()
    return [k for k in styles if k != "common"]


# 하위 호환용 (app.py에서 import)
AVAILABLE_CATEGORIES = list(DEFAULT_CATEGORY_STYLES.keys())


class BlogStyleSkill(SkillBase):
    """보보쌤 블로그 스타일 스킬.

    DB에서 스타일 데이터를 읽어 LLM 프롬프트에 주입합니다.
    DB에 없으면 기본값을 사용합니다.
    """

    @property
    def name(self) -> str:
        return "blog_style"

    @property
    def description(self) -> str:
        return "보보쌤 블로그 스타일 가이드 (카테고리별 문체/구조 적용)"

    def execute(self, context: SkillContext) -> SkillResult:
        category = getattr(context, "category", None) or ""

        # DB에서 스타일 읽기 (없으면 기본값)
        db = getattr(context, "db", None)

        if db:
            common = db.get_blog_style("common") or DEFAULT_COMMON_STYLE
        else:
            common = DEFAULT_COMMON_STYLE

        style_parts = [common]

        # 카테고리별 스타일
        if category:
            if db:
                cat_style = db.get_blog_style(category)
            else:
                cat_style = DEFAULT_CATEGORY_STYLES.get(category)

            if cat_style:
                style_parts.append(cat_style)
            elif db:
                # 부분 매치 시도
                all_styles = db.list_blog_styles()
                for cat_name, style_text in all_styles.items():
                    if cat_name == "common":
                        continue
                    if category in cat_name or cat_name in category:
                        style_parts.append(style_text)
                        break

        summary = "\n".join(style_parts)

        available = get_available_categories(db) if db else AVAILABLE_CATEGORIES

        return SkillResult(
            skill_name=self.name,
            data={
                "blog_name": "의대 간 보보쌤의 공부 & 입시 연구소",
                "blog_id": "byhur99",
                "category": category,
                "available_categories": available,
            },
            summary=summary,
        )
